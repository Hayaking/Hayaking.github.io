import{_ as n,V as s,W as a,a0 as t}from"./framework.1bd1ad73.js";const p={},e=t(`<h2 id="一、init" tabindex="-1"><a class="header-anchor" href="#一、init" aria-hidden="true">#</a> 一、init</h2><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">initPrometheus</span><span class="token punctuation">(</span>r <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			utils<span class="token punctuation">.</span>Log4file<span class="token punctuation">.</span><span class="token function">WithFields</span><span class="token punctuation">(</span>logrus<span class="token punctuation">.</span>Fields<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	p <span class="token operator">:=</span> gp<span class="token punctuation">.</span><span class="token function">NewPrometheus</span><span class="token punctuation">(</span><span class="token string">&quot;gin&quot;</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span><span class="token function">GetBool</span><span class="token punctuation">(</span><span class="token string">&quot;prometheus.enable&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		listen <span class="token operator">:=</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">&quot;prometheus.url.listen&quot;</span><span class="token punctuation">)</span>
		gateway <span class="token operator">:=</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">&quot;prometheus.url.push-gateway&quot;</span><span class="token punctuation">)</span>
		interval <span class="token operator">:=</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span><span class="token function">GetInt64</span><span class="token punctuation">(</span><span class="token string">&quot;prometheus.push-interval&quot;</span><span class="token punctuation">)</span>
		p<span class="token punctuation">.</span><span class="token function">SetPushGateway</span><span class="token punctuation">(</span>
			gateway<span class="token punctuation">,</span>
			listen<span class="token punctuation">,</span>
			time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
		p<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="二、自定义metric" tabindex="-1"><a class="header-anchor" href="#二、自定义metric" aria-hidden="true">#</a> 二、自定义metric</h2><p>通过上面一步，可以把gin框架原生的metric push到gateway。</p><p>需要自定义metric的话参考下面的代码:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;github.com/prometheus/client_golang/prometheus&quot;</span>
	<span class="token string">&quot;github.com/sirupsen/logrus&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> KafkaTopicProducerCommitCount <span class="token operator">=</span> prometheus<span class="token punctuation">.</span><span class="token function">NewCounterVec</span><span class="token punctuation">(</span>prometheus<span class="token punctuation">.</span>CounterOpts<span class="token punctuation">{</span>
	Name<span class="token punctuation">:</span> <span class="token string">&quot;kafka_topic_producer_commit_count&quot;</span><span class="token punctuation">,</span>
	Help<span class="token punctuation">:</span> <span class="token string">&quot;kafka生产者提交次数&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">RegisterKafkaMetric</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	prometheus<span class="token punctuation">.</span><span class="token function">MustRegister</span><span class="token punctuation">(</span>KafkaTopicProducerCommitCount<span class="token punctuation">)</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;github.com/prometheus/client_golang/prometheus&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> LoganFileSizeSummaryMetric <span class="token operator">=</span> prometheus<span class="token punctuation">.</span><span class="token function">NewSummaryVec</span><span class="token punctuation">(</span>prometheus<span class="token punctuation">.</span>SummaryOpts<span class="token punctuation">{</span>
	Name<span class="token punctuation">:</span>       <span class="token string">&quot;logan_file_size&quot;</span><span class="token punctuation">,</span>
	Help<span class="token punctuation">:</span>       <span class="token string">&quot;logan请求体大小&quot;</span><span class="token punctuation">,</span>
	Objectives<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">float64</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">{</span><span class="token number">0.5</span><span class="token punctuation">:</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">:</span> <span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.99</span><span class="token punctuation">:</span> <span class="token number">0.001</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content_type&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> LoganParseElapsedSummaryMetric <span class="token operator">=</span> prometheus<span class="token punctuation">.</span><span class="token function">NewSummaryVec</span><span class="token punctuation">(</span>prometheus<span class="token punctuation">.</span>SummaryOpts<span class="token punctuation">{</span>
	Name<span class="token punctuation">:</span>       <span class="token string">&quot;logan_parse_file_elapsed&quot;</span><span class="token punctuation">,</span>
	Help<span class="token punctuation">:</span>       <span class="token string">&quot;logan文件被解析的速度&quot;</span><span class="token punctuation">,</span>
	Objectives<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">float64</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">{</span><span class="token number">0.5</span><span class="token punctuation">:</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">:</span> <span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.99</span><span class="token punctuation">:</span> <span class="token number">0.001</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content_type&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> LoganParserOutBufferMetric <span class="token operator">=</span> prometheus<span class="token punctuation">.</span><span class="token function">NewGaugeVec</span><span class="token punctuation">(</span>prometheus<span class="token punctuation">.</span>GaugeOpts<span class="token punctuation">{</span>
	Name<span class="token punctuation">:</span> <span class="token string">&quot;logan_parser_out_buffer_size&quot;</span><span class="token punctuation">,</span>
	Help<span class="token punctuation">:</span> <span class="token string">&quot;logan解析后的buffer chan大小&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;domain&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">RegisterLoganMetric</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	prometheus<span class="token punctuation">.</span><span class="token function">MustRegister</span><span class="token punctuation">(</span>LoganFileSizeSummaryMetric<span class="token punctuation">)</span>
	prometheus<span class="token punctuation">.</span><span class="token function">MustRegister</span><span class="token punctuation">(</span>LoganParseElapsedSummaryMetric<span class="token punctuation">)</span>
	prometheus<span class="token punctuation">.</span><span class="token function">MustRegister</span><span class="token punctuation">(</span>LoganParserOutBufferMetric<span class="token punctuation">)</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,7),o=[e];function c(u,i){return s(),a("div",null,o)}const k=n(p,[["render",c],["__file","gin集成prometheus.html.vue"]]);export{k as default};
